<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="author" content="SofiaC++"><meta name="description"><title>Smart Resources&mdash;Advanced C++</title><link href="/advanced-cpp/favicon.png" rel="icon"><link rel="alternate" href="/advanced-cpp/atom.xml" title="config.title" type="application/atom.xml"><link href="/advanced-cpp/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"><link href="/advanced-cpp/bower_components/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet"><link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css" rel="stylesheet"><style>body { padding-top: 50px; }</style></head><body><div class="container"><nav role="navigation" class="navbar navbar-inverse navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Advanced C++</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/advanced-cpp/categories/news/">News</a></li><li><a href="/advanced-cpp/categories/slides/">Slides</a></li><li><a href="/advanced-cpp/about/">About</a></li></ul></div></div></nav><div class="page-header"><h1><a href="/advanced-cpp/">Advanced C++</a></h1><p id="site-slogan">Site for the Advanced C++ course at FMI</p></div><div class="row"><div class="col-sm-9"><section id="content"><article class="post"><h2>Smart Resources</h2><div class="meta">05 Mar 2017 in <a href="/advanced-cpp/categories/slides/">slides</a>&ensp;</div><a href="/advanced-cpp/slides/06_smart_resource.html" class="btn btn-large btn-primary">Slide Show</a><section><h1>&quot;Smart&quot; Resource Management</h1>
</section><section><h2>Contents</h2>
<ol>
<li>Ownership</li>
<li>Sharing</li>
<li>Using / Pointing</li>
</ol>
</section><section><section><h2>Ownership</h2>
</section><section><p>Ownership is best expressed with <code>std::unique_ptr</code>.</p>
</section><section><h3>Heap-allocated object</h3>
</section><section><pre><code>class Logger {
    private:
        std::unique_ptr&lt;ILogTarget&gt; _Target;
};
</code></pre>
</section><section><h3>Heap-allocated array</h3>
</section><section><pre><code>int hash(const char* name) {
    std::ifstream input(name, std::ios::binary);
    const auto size = 4096;
    std::unique_ptr&lt;char[]&gt; buffer(new char[size]);
    int h = 42;
    while (input) {
        input.read(buffer.get(), size);
        h = h + buffer[42] % 42;
    }
    return h;
}
</code></pre>
</section><section><h3>C-style resource</h3>
</section><section><h4>How to own a <code>FILE*</code></h4>
<p>It is the same as every other resource:</p>
<ul>
<li>obtain - <code>fopen</code></li>
<li>return - <code>fclose</code></li>
</ul>
</section><section><pre><code>struct FCloserDeleter
{
    void operator()(FILE* file) const
    {
        if (file)
        {
            fclose(file);
        }
    }
};

typedef std::unique_ptr&lt;FILE, FCloserDeleter&gt; FilePtr;
</code></pre>
</section><section><h3>Custom deleter</h3>
</section><section></section><section><h3>Directly using a deleter</h3>
</section><section><pre><code>template &lt;typename T&gt;
using UniqueReleasePtr&lt;T&gt; = std::unique_ptr&lt;T, ReleaseDeleter&gt;;

template &lt;typename T&gt;
using UniqueDestroyPtr&lt;T&gt; = std::unique_ptr&lt;T, DestroyDeleter&gt;;
</code></pre>
</section><section><pre><code>namespace std
{
template &lt;&gt;
struct default_delete&lt;ID3DDevice&gt;
{
    void operator()(ID3DDevice* ptr) const
    {
        ptr-&gt;Release();
    }
}
}
</code></pre>
</section><section><h3><code>owner</code></h3>
<p>Presented in
<a href="http://www.stroustrup.com/resource-model.pdf" target="_blank" rel="external">A brief introduction to C++â€™s model for type and resource safety</a></p>
</section><section><p>Implemented in:</p>
<pre><code>template &lt;class T&gt;
using owner = T;
</code></pre>
<p>https://github.com/Microsoft/GSL/blob/master/include/gsl/gsl#L55</p>
</section><section><p>Static checkers:</p>
<ul>
<li><a href="http://clang.llvm.org/extra/clang-tidy/" target="_blank" rel="external"><code>clang-tidy</code></a></li>
<li><a href="https://blogs.msdn.microsoft.com/vcblog/2015/12/03/c-core-guidelines-checkers-available-for-vs-2015-update-1/" target="_blank" rel="external">Visual Studio</a></li>
</ul>
</section></section><section><section><h2>Sharing</h2>
</section><section><ul>
<li>Use <code>intrusive_ptr</code> or <code>shared_ptr</code></li>
</ul>
</section></section><section><section><h2>Using / Pointing</h2>
</section><section><ul>
<li>Use a plain pointer
<ul>
<li><a href="https://github.com/Microsoft/GSL/blob/master/include/gsl/gsl#L72" target="_blank" rel="external"><code>not_null</code></a></li>
</ul>
</li>
<li>Use a reference</li>
</ul>
</section></section></article><div class="row-fluid"><div class="col-md-12"><hr><ul class="pagination"><li><a href="/advanced-cpp/2017/03/12/namespaces/" title="Previous articles">&larr; Previous</a></li><li><a href="/advanced-cpp/2017/03/01/smart-pointers/" title="Next articles">Next &rarr;</a></li></ul></div></div></section></div><div class="col-sm-3"><nav role="navigation" class="navbar navbar-default"><div class="navbar-header"><div class="navbar-brand">Recent Posts</div></div><div class="clearfix"></div><ul class="nav navbar-stacked"><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li><li><a href="/advanced-cpp/2017/03/14/functional/">Functional C++</a></li></ul></nav></div></div><footer id="page-footer"><footer><div class="row-fluid"><div class="col-md-12"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" width="88px" height="31px" src="/advanced-cpp/images/cc-by-sa.png"></a><br><span>Advanced C++</span> by<span> SofiaC++</span> is licensed under a&nbsp;<a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International
License
</a></div></div></footer><script src="/advanced-cpp/bower_components/jquery/dist/jquery.min.js"></script><script src="/advanced-cpp/bower_components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/advanced-cpp/snippet.js"></script></footer></div></body></html>